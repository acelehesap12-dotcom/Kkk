# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘           ğŸ‘‘ K99 EXCHANGE - DOCKER COMPOSE (PRODUCTION)        â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 
# Production deployment iÃ§in kullanÄ±lÄ±r
# Environment variables: .env dosyasÄ±ndan okunur
#
# KullanÄ±m:
#   docker-compose -f docker-compose.prod.yml up -d

version: '3.8'

services:
  # ========================================
  # USER SERVICE - Authentication & K99
  # ========================================
  user-service:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    image: k99-user-service:latest
    container_name: k99-user-service
    restart: always
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - REDIS_TOKEN=${REDIS_TOKEN}
      - JWT_SECRET=${JWT_SECRET}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - k99-network

  # ========================================
  # ORDER GATEWAY - WebSocket Gateway
  # ========================================
  order-gateway:
    build:
      context: ./order-gateway
      dockerfile: Dockerfile
    image: k99-order-gateway:latest
    container_name: k99-order-gateway
    restart: always
    ports:
      - "8080:8080"
    environment:
      - PORT=8080
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - KAFKA_BROKERS=${KAFKA_BROKERS}
      - KAFKA_USERNAME=${KAFKA_USERNAME}
      - KAFKA_PASSWORD=${KAFKA_PASSWORD}
      - SECURITY_PROTOCOL=${SECURITY_PROTOCOL}
      - SASL_MECHANISM=${SASL_MECHANISM}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - k99-network

  # ========================================
  # MARKET DATA SERVICE - Price Feeds
  # ========================================
  market-data:
    build:
      context: ./market-data-service
      dockerfile: Dockerfile
    image: k99-market-data:latest
    container_name: k99-market-data
    restart: always
    ports:
      - "8081:8081"
    environment:
      - HTTP_PORT=8081
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - KAFKA_BROKERS=${KAFKA_BROKERS}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - k99-network

  # ========================================
  # MATCHING ENGINE - Order Matching (Rust)
  # ========================================
  matching-engine:
    build:
      context: ./matching-engine
      dockerfile: Dockerfile
    image: k99-matching-engine:latest
    container_name: k99-matching-engine
    restart: always
    environment:
      - RUST_LOG=info
      - KAFKA_BROKERS=${KAFKA_BROKERS}
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
    networks:
      - k99-network

  # ========================================
  # RISK ENGINE - Risk Management (Python)
  # ========================================
  risk-engine:
    build:
      context: ./risk-engine
      dockerfile: Dockerfile
    image: k99-risk-engine:latest
    container_name: k99-risk-engine
    restart: always
    ports:
      - "8082:8082"
    environment:
      - PORT=8082
      - DATABASE_URL=${DATABASE_URL}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - k99-network

  # ========================================
  # QUANT STUDIO - Algorithm Sandbox
  # ========================================
  quant-studio:
    build:
      context: ./quant-studio
      dockerfile: Dockerfile
    image: k99-quant-studio:latest
    container_name: k99-quant-studio
    restart: always
    ports:
      - "8083:8083"
    environment:
      - PORT=8083
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    # Network isolation for security
    network_mode: "none"

  # ========================================
  # SETTLEMENT SERVICE - Blockchain Settlement
  # ========================================
  settlement:
    build:
      context: ./settlement-service
      dockerfile: Dockerfile
    image: k99-settlement:latest
    container_name: k99-settlement
    restart: always
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=production
      - PORT=3002
      - DATABASE_URL=${DATABASE_URL}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - k99-network

  # ========================================
  # FRONTEND - Next.js Static Export
  # ========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    image: k99-frontend:latest
    container_name: k99-frontend
    restart: always
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
    networks:
      - k99-network

  # ========================================
  # NGINX REVERSE PROXY
  # ========================================
  nginx:
    image: nginx:alpine
    container_name: k99-nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - frontend
      - user-service
      - order-gateway
      - market-data
    networks:
      - k99-network

networks:
  k99-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
